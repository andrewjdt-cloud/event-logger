<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Competition Time Logger</title>

<style>
body{
  font-family:system-ui,sans-serif;
  background:#111;color:#fff;
  margin:0;padding:16px;text-align:center;
}
.header{margin-bottom:12px}
.event-name{font-size:20px;font-weight:600}
.event-location{font-size:13px;color:#aaa}
.closed{color:#ff5252;font-weight:bold}

.controls{display:flex;gap:8px;justify-content:center;margin:12px 0}
select,button,input{
  font-size:16px;padding:8px;border-radius:8px;border:none
}
select,input{background:#222;color:#fff}

.nav{display:flex;gap:10px;justify-content:center;margin-bottom:10px}

.competitor{margin:18px 0}
.comp-number{font-size:42px;font-weight:bold}
.comp-name{font-size:18px;color:#8bc34a}

button.log{
  width:100%;font-size:22px;padding:16px;
  border-radius:14px;background:#00c853;color:#000
}
button.log:disabled{opacity:0.4}

.status{margin-top:10px;font-size:14px;color:#ffeb3b}
</style>
</head>

<body>

<div class="header">
  <div class="event-name" id="eventName"></div>
  <div class="event-location" id="eventLocation"></div>
  <div id="closedNotice" class="closed" style="display:none">
    Event is currently CLOSED
  </div>
</div>

<div class="controls">
  <select id="eventSelect"></select>
  <select id="roundSelect"></select>
</div>

<div class="nav">
  <button id="prevBtn">◀ Prev</button>
  <button id="nextBtn">Next ▶</button>
</div>

<div class="competitor">
  <div class="comp-number" id="compNumber">—</div>
  <div class="comp-name" id="compName">—</div>
</div>

<button class="log" id="logBtn">LOG ENTRY</button>

<div class="status" id="statusText"></div>

<script>
const SHEET_ID="1EsFTZZkAbdVCYu8wT_gR2V_l_knRAGSmD0F5X0PA3rE";
const API_URL="https://script.google.com/macros/s/AKfycbwYs40Fhv2l6gfPRIxTeVqkd8pnu23bA3SDyrdPA05bClVbDrRmoHcSkVTmYgEvhn93yg/exec";

const EVENTCONFIG_GID=0;
const EVENTS_GID=1157267667;
const ROUNDS_GID=1872371459;
const COMPETITORS_GID=1455640270;
const TIMELOG_GID=1894563340;

let competitors=[], index=0, completed={}, eventOpen=true;

function parseGViz(t){
  return JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
}

/* ===== EVENT CONFIG (HEADER AWARE) ===== */
async function loadEventConfig(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENTCONFIG_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());

  j.table.rows.slice(1).forEach(r=>{
    const key=(r.c[0]?.v||"").trim();
    const val=(r.c[1]?.v||"").trim();

    if(key==="EventName") eventName.textContent=val;
    if(key==="Location") eventLocation.textContent=val;
    if(key==="ActiveEvent" && val.toUpperCase()!=="YES"){
      eventOpen=false;
      logBtn.disabled=true;
      closedNotice.style.display="block";
    }
  });
}

/* ===== EVENTS ===== */
async function loadEvents(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENTS_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  eventSelect.innerHTML="";
  j.table.rows.slice(1).forEach(r=>{
    const v=r.c[0]?.v;
    if(v){
      const o=document.createElement("option");
      o.textContent=String(v);
      eventSelect.appendChild(o);
    }
  });
}

/* ===== ROUNDS (ROBUST) ===== */
async function loadRounds(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${ROUNDS_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  roundSelect.innerHTML="";
  j.table.rows.slice(1).forEach(r=>{
    const cell=r.c[0];
    const v=cell?.f ?? cell?.v;
    if(v!==undefined && v!==null && v!==""){
      const o=document.createElement("option");
      o.textContent=String(v);
      roundSelect.appendChild(o);
    }
  });
}

/* ===== COMPETITORS ===== */
async function loadCompetitors(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${COMPETITORS_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  const h=j.table.cols.map(c=>c.label);
  const hi={
    order:h.indexOf("CompetitorOrder"),
    number:h.indexOf("CompetitorNumber"),
    name:h.indexOf("CompetitorName")
  };
  competitors=j.table.rows.map(r=>({
    order:r.c[hi.order]?.v,
    number:r.c[hi.number]?.v,
    name:r.c[hi.name]?.v
  })).sort((a,b)=>a.order-b.order);
}

/* ===== RESUME (LOG/UNDO AWARE) ===== */
async function resumeFromTimeLog(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${TIMELOG_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());

  j.table.rows.forEach(r=>{
    const comp=r.c[3]?.v;
    const action=r.c[9]?.v;
    if(!comp||!action) return;
    if(action==="LOG") completed[comp]=true;
    if(action==="UNDO") completed[comp]=false;
    if(action==="LOG"){
      eventSelect.value=r.c[1]?.v||eventSelect.value;
      roundSelect.value=r.c[2]?.v||roundSelect.value;
    }
  });

  const next=competitors.findIndex(c=>!completed[c.number]);
  index=next>=0?next:competitors.length-1;
}

function showCompetitor(){
  const c=competitors[index];
  if(c){
    compNumber.textContent=c.number;
    compName.textContent=c.name;
  }
}

prevBtn.onclick=()=>{ if(index>0){index--;showCompetitor();} };
nextBtn.onclick=()=>{ if(index<competitors.length-1){index++;showCompetitor();} };

logBtn.onclick=async()=>{
  if(!eventOpen) return;
  const c=competitors[index];
  if(!c) return;
  await fetch(API_URL,{method:"POST",body:JSON.stringify({
    event:eventSelect.value,
    round:roundSelect.value,
    competitorId:c.number,
    competitorName:c.name,
    action:"LOG"
  })});
  completed[c.number]=true;
  index++;
  showCompetitor();
};

(async()=>{
  await loadEventConfig();
  await loadEvents();
  await loadRounds();
  await loadCompetitors();
  await resumeFromTimeLog();
  showCompetitor();
})();
</script>

</body>
</html>
