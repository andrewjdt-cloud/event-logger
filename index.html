<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Competition Time Logger</title>

<style>
body{
  font-family:system-ui,sans-serif;
  background:#111;color:#fff;
  margin:0;padding:16px;text-align:center;
}
.header{margin-bottom:12px}
.event-name{font-size:20px;font-weight:600}
.event-location{font-size:13px;color:#aaa}
.closed{color:#ff5252;font-weight:bold}

.controls{display:flex;gap:8px;justify-content:center;margin:12px 0}
select,button,input{
  font-size:16px;padding:8px;border-radius:8px;border:none
}
select,input{background:#222;color:#fff}

.nav{display:flex;gap:10px;justify-content:center;margin-bottom:10px}

.competitor{margin:18px 0}
.comp-number{font-size:42px;font-weight:bold}
.comp-name{font-size:18px;color:#8bc34a}

button.log{
  width:100%;font-size:22px;padding:16px;
  border-radius:14px;background:#00c853;color:#000
}
button.log:disabled{opacity:0.4}

.extras{margin-top:12px;text-align:left}
.status{margin-top:10px;font-size:14px;color:#ff5252}

/* SUCCESS OVERLAY (from Freestyle) */
.success-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:100;pointer-events:none;
}
.success-overlay.hidden{display:none}

.success-tick{
  width:96px;height:96px;margin-bottom:16px;
}
.success-tick svg{
  width:100%;height:100%;
  stroke:#00e676;stroke-width:8;fill:none;
}

.countdown{
  font-size:72px;font-weight:bold;
  color:#ffeb3b;
  animation:pulse 1s infinite;
}

@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}
</style>
</head>

<body>

<div class="header">
  <div class="event-name" id="eventName"></div>
  <div class="event-location" id="eventLocation"></div>
  <div id="closedNotice" class="closed" style="display:none">
    Event is currently CLOSED
  </div>
</div>

<div class="controls">
  <select id="eventSelect"></select>
  <select id="roundSelect"></select>
</div>

<div class="nav">
  <button id="prevBtn">◀ Prev</button>
  <button id="nextBtn">Next ▶</button>
</div>

<div class="competitor">
  <div class="comp-number" id="compNumber">—</div>
  <div class="comp-name" id="compName">—</div>
</div>

<button class="log" id="logBtn">LOG ENTRY</button>

<div class="extras">
  <label><input type="checkbox" id="rerunChk"> Rerun</label>
  <select id="rerunReason" disabled>
    <option value="">Reason</option>
  </select>
  <button id="undoBtn">Undo last</button>
</div>

<div class="status" id="statusText"></div>

<!-- SUCCESS OVERLAY -->
<div class="success-overlay hidden" id="successOverlay">
  <div class="success-tick">
    <svg viewBox="0 0 52 52">
      <path d="M14 27 L22 35 L38 17"/>
    </svg>
  </div>
  <div class="countdown" id="countdownText">3</div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID="1EsFTZZkAbdVCYu8wT_gR2V_l_knRAGSmD0F5X0PA3rE";
const API_URL="https://script.google.com/macros/s/AKfycbwYs40Fhv2l6gfPRIxTeVqkd8pnu23bA3SDyrdPA05bClVbDrRmoHcSkVTmYgEvhn93yg/exec";

const EVENTCONFIG_GID=0;
const EVENTS_GID=1157267667;
const ROUNDS_GID=1872371459;
const COMPETITORS_GID=1455640270;
const TIMELOG_GID=1894563340;
const RERUN_GID=/* PUT GID HERE */;

/* AUTH */
const params=new URLSearchParams(location.search);
const logger=params.get("logger");
const token=params.get("token");

/* STATE */
let competitors=[], index=0, completed={}, lastLog=null, eventOpen=true;

/* HELPERS */
function parseGViz(t){
  return JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
}

/* LOADERS */
async function loadEventConfig(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENTCONFIG_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  j.table.rows.slice(1).forEach(r=>{
    const k=(r.c[0]?.v||"").trim();
    const v=(r.c[1]?.v||"").trim();
    if(k==="EventName") eventName.textContent=v;
    if(k==="Location") eventLocation.textContent=v;
    if(k==="ActiveEvent" && v.toUpperCase()!=="YES"){
      eventOpen=false;
      logBtn.disabled=true;
      closedNotice.style.display="block";
    }
  });
}

async function loadEvents(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENTS_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  eventSelect.innerHTML="";
  j.table.rows.slice(1).forEach(r=>{
    if(r.c[0]?.v){
      const o=document.createElement("option");
      o.textContent=r.c[0].v;
      eventSelect.appendChild(o);
    }
  });
}

async function loadRounds(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${ROUNDS_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  roundSelect.innerHTML="";
  j.table.rows.slice(1).forEach(r=>{
    const v=r.c[0]?.f ?? r.c[0]?.v;
    if(v){
      const o=document.createElement("option");
      o.textContent=String(v);
      roundSelect.appendChild(o);
    }
  });
}

async function loadRerunReasons(){
  if(!RERUN_GID) return;
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${RERUN_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  rerunReason.innerHTML=`<option value="">Reason</option>`;
  j.table.rows.slice(1).forEach(r=>{
    if(r.c[0]?.v){
      const o=document.createElement("option");
      o.textContent=r.c[0].v;
      rerunReason.appendChild(o);
    }
  });
}

async function loadCompetitors(){
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${COMPETITORS_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());
  const h=j.table.cols.map(c=>c.label);
  const hi={
    order:h.indexOf("CompetitorOrder"),
    number:h.indexOf("CompetitorNumber"),
    name:h.indexOf("CompetitorName")
  };
  competitors=j.table.rows.map(r=>({
    order:r.c[hi.order]?.v,
    number:r.c[hi.number]?.v,
    name:r.c[hi.name]?.v
  })).sort((a,b)=>a.order-b.order);
}

/* PROGRESSION */
async function recomputeProgression(){
  completed={};
  const r=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${TIMELOG_GID}&tqx=out:json`);
  const j=parseGViz(await r.text());

  j.table.rows.forEach(row=>{
    const ev=row.c[1]?.v;
    const rd=row.c[2]?.v;
    const comp=row.c[3]?.v;
    const act=row.c[9]?.v;

    if(String(ev)!==String(eventSelect.value)) return;
    if(String(rd)!==String(roundSelect.value)) return;

    if(act==="LOG") completed[comp]=true;
    if(act==="UNDO") completed[comp]=false;
  });

  const next=competitors.findIndex(c=>!completed[c.number]);
  index=next>=0?next:competitors.length-1;
  showCompetitor();
}

/* UI */
function showCompetitor(){
  const c=competitors[index];
  if(c){
    compNumber.textContent=c.number;
    compName.textContent=c.name;
  }
}

prevBtn.onclick=()=>{ if(index>0){index--;showCompetitor();} };
nextBtn.onclick=()=>{ if(index<competitors.length-1){index++;showCompetitor();} };
rerunChk.onchange=()=>rerunReason.disabled=!rerunChk.checked;

eventSelect.onchange=recomputeProgression;
roundSelect.onchange=recomputeProgression;

/* SUCCESS FLOW */
function startCountdown(){
  successOverlay.classList.remove("hidden");
  let n=3;
  countdownText.textContent=n;
  const iv=setInterval(()=>{
    n--;
    countdownText.textContent=n;
    if(n===0){
      clearInterval(iv);
      successOverlay.classList.add("hidden");
      recomputeProgression();
    }
  },1000);
}

/* LOG */
logBtn.onclick=async()=>{
  if(!eventOpen) return;
  const c=competitors[index];
  if(!c) return;

  lastLog={
    logger,token,
    event:eventSelect.value,
    round:roundSelect.value,
    competitorId:c.number,
    competitorName:c.name,
    isRerun:rerunChk.checked,
    rerunReason:rerunReason.value,
    notes:"",
    action:"LOG"
  };

  await fetch(API_URL,{method:"POST",body:JSON.stringify(lastLog)});
  startCountdown();
};

/* UNDO */
undoBtn.onclick=async()=>{
  if(!lastLog) return;
  await fetch(API_URL,{method:"POST",body:JSON.stringify({...lastLog,action:"UNDO"})});
  statusText.textContent="Last entry undone";
  recomputeProgression();
};

/* BOOT */
(async()=>{
  await loadEventConfig();
  await loadEvents();
  await loadRounds();
  await loadRerunReasons();
  await loadCompetitors();
  await recomputeProgression();
})();
</script>

</body>
</html>
