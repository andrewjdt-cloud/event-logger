<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CP Competition Time Logger</title>

<style>
body{
  font-family:system-ui,sans-serif;
  background:#111;color:#fff;
  margin:0;padding:16px;text-align:center;
}
.header{margin-bottom:12px}
.event-name{font-size:20px;font-weight:600}
.event-location{font-size:13px;color:#aaa}
.closed{color:#ff5252;font-weight:bold}

.controls{display:flex;gap:8px;justify-content:center;margin:12px 0}
select,button{
  font-size:16px;padding:8px;border-radius:8px;border:none
}
select{background:#222;color:#fff}

.nav{display:flex;gap:10px;justify-content:center;margin-bottom:10px}

.competitor{margin:18px 0}
.comp-number{font-size:42px;font-weight:bold}
.comp-name{font-size:18px;color:#8bc34a}

button.log{
  width:100%;font-size:22px;padding:16px;
  border-radius:14px;background:#00c853;color:#000
}

.extras{margin-top:12px;text-align:left}
.status{margin-top:10px;font-size:14px;color:#ffeb3b}

/* SUCCESS OVERLAY */
.success-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:100;pointer-events:none;
}
.success-overlay.hidden{display:none}

.success-tick{width:96px;height:96px;margin-bottom:16px}
.success-tick svg{stroke:#00e676;stroke-width:8;fill:none}

.countdown{
  font-size:72px;font-weight:bold;
  color:#ffeb3b;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.15)}
  100%{transform:scale(1)}
}
</style>
</head>

<body>

<div class="header">
  <div class="event-name" id="eventName"></div>
  <div class="event-location" id="eventLocation"></div>
  <div id="closedNotice" class="closed" style="display:none">
    Event is currently CLOSED
  </div>
</div>

<div class="controls">
  <select id="eventSelect"></select>
  <select id="roundSelect"></select>
</div>

<div class="nav">
  <button id="prevBtn">◀ Prev</button>
  <button id="nextBtn">Next ▶</button>
</div>

<div class="competitor">
  <div class="comp-number" id="compNumber">—</div>
  <div class="comp-name" id="compName">—</div>
</div>

<button class="log" id="logBtn">LOG ENTRY</button>

<div class="extras">
  <label><input type="checkbox" id="rerunChk"> Rerun</label>
  <select id="rerunReason" disabled></select>
  <button id="undoBtn">Undo last</button>
</div>

<div class="status" id="statusText"></div>

<div class="success-overlay hidden" id="successOverlay">
  <div class="success-tick">
    <svg viewBox="0 0 52 52"><path d="M14 27 L22 35 L38 17"/></svg>
  </div>
  <div class="countdown" id="countdownText">3</div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID="1EsFTZZkAbdVCYu8wT_gR2V_l_knRAGSmD0F5X0PA3rE";
const API_URL="https://script.google.com/macros/s/AKfycbyCAYRIjhXoDRqYKeoTKNpQlGUzDk6Jv6BHZxAxL1e40Ufw1tzuGqoDHZST1-Vo9yxgvQ/exec";

const EVENTCONFIG_GID=0;
const EVENTS_GID=1157267667;
const ROUNDS_GID=1872371459;
const COMPETITORS_GID=1455640270;
const TIMELOG_GID=1894563340;
const RERUN_GID=110041342;

/* AUTH */
const params = new URLSearchParams(location.search);
const logger = params.get("logger");
const token  = params.get("token");

/* STATE */
let competitors = [];
let index = 0;
let completed = {};
let lastLog = null;
let eventOpen = true;

/* ================= HELPERS ================= */
function parseGViz(t){
  return JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
}

/* ================= LOADERS ================= */
async function loadEventConfig(){
  const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${EVENTCONFIG_GID}&tqx=out:json`);
  const j = parseGViz(await res.text());

  j.table.rows.slice(1).forEach(r=>{
    const k = r.c[0]?.v;
    const v = r.c[1]?.v;

    if(k==="EventName") eventName.textContent = v || "";
    if(k==="Location") eventLocation.textContent = v || "";
    if(k==="ActiveEvent" && String(v).toUpperCase()!=="YES"){
      eventOpen = false;
      closedNotice.style.display = "block";
    }
  });
}

async function loadSimpleList(gid, select){
  const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${gid}&tqx=out:json`);
  const j = parseGViz(await res.text());

  select.innerHTML = "";
  j.table.rows.slice(1).forEach(r=>{
    if(r.c[0]?.v){
      const o = document.createElement("option");
      o.textContent = r.c[0].v;
      select.appendChild(o);
    }
  });
}

async function loadCompetitors(){
  const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${COMPETITORS_GID}&tqx=out:json`);
  const j = parseGViz(await res.text());

  const h = j.table.cols.map(c=>c.label);
  competitors = j.table.rows.map(r=>({
    order: r.c[h.indexOf("CompetitorOrder")]?.v,
    number: r.c[h.indexOf("CompetitorNumber")]?.v,
    name: r.c[h.indexOf("CompetitorName")]?.v
  })).sort((a,b)=>a.order-b.order);
}

/* ================= PROGRESSION ================= */
async function recomputeProgression(){
  completed = {};
  const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${TIMELOG_GID}&tqx=out:json`);
  const j = parseGViz(await res.text());

  j.table.rows.forEach(r=>{
    if(r.c[1]?.v==eventSelect.value && r.c[2]?.v==roundSelect.value){
      completed[r.c[3]?.v] = r.c[9]?.v==="LOG";
    }
  });

  const next = competitors.findIndex(c=>!completed[c.number]);
  index = next >= 0 ? next : competitors.length - 1;
  showCompetitor();
}

/* ================= UI ================= */
function showCompetitor(){
  const c = competitors[index];
  compNumber.textContent = c ? c.number : "—";
  compName.textContent   = c ? c.name   : "—";
}

prevBtn.onclick = ()=>{ if(index>0){ index--; showCompetitor(); }};
nextBtn.onclick = ()=>{ if(index<competitors.length-1){ index++; showCompetitor(); }};
rerunChk.onchange = ()=> rerunReason.disabled = !rerunChk.checked;
eventSelect.onchange = recomputeProgression;
roundSelect.onchange = recomputeProgression;

/* ================= FEEDBACK ================= */
function startCountdown(){
  successOverlay.classList.remove("hidden");
  let n = 3;
  countdownText.textContent = n;

  const iv = setInterval(()=>{
    n--;
    countdownText.textContent = n;
    if(n===0){
      clearInterval(iv);
      successOverlay.classList.add("hidden");
      recomputeProgression();
    }
  },1000);
}

/* ================= LOG ================= */
logBtn.onclick = () => {
  if (!eventOpen) return;
  const c = competitors[index];
  if (!c) return;

  lastLog = {
    logger,
    token,
    event: eventSelect.value,
    round: roundSelect.value,
    competitorId: c.number,
    competitorName: c.name,
    isRerun: rerunChk.checked ? "YES" : "NO",
    rerunReason: rerunChk.checked ? rerunReason.value : "",
    notes: "",
    action: "LOG"
  };

  // UI feedback immediately
  startCountdown();
  statusText.textContent = "Logged";

  // Build form body (ANDROID SAFE)
  const body = new URLSearchParams(lastLog).toString();

  // Fire-and-forget POST
  fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body
  });
};
  statusText.textContent = "Logged";
};

/* ================= UNDO ================= */
undoBtn.onclick = () => {
  if (!lastLog) return;

  const body = new URLSearchParams({
    ...lastLog,
    action: "UNDO"
  }).toString();

  fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body
  });

  statusText.textContent = "Last entry undone";
  recomputeProgression();
};
  
/* ================= BOOT ================= */
(async()=>{
  await loadEventConfig();
  await loadSimpleList(EVENTS_GID, eventSelect);
  await loadSimpleList(ROUNDS_GID, roundSelect);
  await loadSimpleList(RERUN_GID, rerunReason);
  await loadCompetitors();
  await recomputeProgression();
})();
</script>
</body>
</html>
